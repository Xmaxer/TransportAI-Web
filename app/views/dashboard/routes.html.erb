<% content_for(:header) do %>
<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-firestore.js"></script>
<% end %>
<div class="row">
  <div class="col-md-12">
    <div class="card card-plain">
      <div class="card-header">
        Google Maps
      </div>
      <div class="card-body">
        <div id="map" class="map"></div>
      </div>
    </div>
  </div>
</div>
<script>

function initMap() {
  // The location of Uluru
  var uluru = {lat: 51.8987528, lng: -8.4706315};
  // The map, centered at Uluru
  var map = new google.maps.Map(
    document.getElementById('map'), {zoom: 12, center: uluru, gestureHandling: 'cooperative',
    styles: [
              {elementType: 'geometry', stylers: [{color: '#27293d'}]},
              {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
              {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
              {
                featureType: 'administrative.locality',
                elementType: 'labels.text.fill',
                stylers: [{color: '#dbdcdf'}]
              },
              {
                featureType: 'poi',
                elementType: 'labels.text.fill',
                stylers: [{color: '#505066'}]
              },
              {
                featureType: 'poi.park',
                elementType: 'geometry',
                stylers: [{color: '#505066'}]
              },
              {
                featureType: 'poi.park',
                elementType: 'labels.text.fill',
                stylers: [{color: '#6b9a76'}]
              },
              {
                featureType: 'road',
                elementType: 'geometry',
                stylers: [{color: '#38414e'}]
              },
              {
                featureType: 'road',
                elementType: 'geometry.stroke',
                stylers: [{color: '#212a37'}]
              },
              {
                featureType: 'road',
                elementType: 'labels.text.fill',
                stylers: [{color: '#9ca5b3'}]
              },
              {
                featureType: 'road.highway',
                elementType: 'geometry',
                stylers: [{color: '#4c6aaa'}]
              },
              {
                featureType: 'road.highway',
                elementType: 'geometry.stroke',
                stylers: [{color: '#1f2835'}]
              },
              {
                featureType: 'road.highway',
                elementType: 'labels.text.fill',
                stylers: [{color: '#f3d19c'}]
              },
              {
                featureType: 'transit',
                elementType: 'geometry',
                stylers: [{color: '#505066'}]
              },
              {
                featureType: 'transit.station',
                elementType: 'labels.text.fill',
                stylers: [{color: '#d59563'}]
              },
              {
                featureType: 'water',
                elementType: 'geometry',
                stylers: [{color: '#17263c'}]
              },
              {
                featureType: 'water',
                elementType: 'labels.text.fill',
                stylers: [{color: '#515c6d'}]
              },
              {
                featureType: 'water',
                elementType: 'labels.text.stroke',
                stylers: [{color: '#17263c'}]
              }
            ]});

    if(!firebase.apps.length) {
      firebase.initializeApp({
        apiKey: '<%= ENV['GOOGLE_API_KEY'] %>',
        authDomain: '<%= ENV['FIRESTORE_PROJECT'] %>.firebaseapp.com',
        projectId: '<%= ENV['FIRESTORE_PROJECT'] %>'
      });
    }

  // Initialize Cloud Firestore through Firebase
  var db = firebase.firestore();

  // Disable deprecated features
  db.settings({
    timestampsInSnapshots: true
  });

  var markers = [];
  db.collection("cars").onSnapshot(function(ss) {
    ss.docChanges().forEach(function(change) {
      if(change.type == "modified" || change.type == "added"){
        var doc = change.doc.data();
        var markerName = change.doc.id;
        var latlng = {lat: doc.location.latitude, lng: doc.location.longitude};
        var i;
        var found = -1;
        for(i = 0; i < markers.length; i++)
        {
          if(markers[i].title == markerName) {
            markers[i].setPosition(latlng);
            found = i;
            break;
          }
        }

        if(found <= 0) {
          var marker = new google.maps.Marker({
            position: latlng,
            title: markerName,
            map: map
          });
          markers.push(marker);
        }
      }
    });
  });
  }
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_KEY'] %>&callback=initMap">
</script>
